name: General CI

on:
  push:
    paths-ignore:
      - "**.md"
  pull_request:
    paths-ignore:
      - "**.md"

jobs:
  no-scheduling:
    runs-on: ubuntu-latest
    steps:
      - name: Delay scheduling of jobs
        run: sleep 10

  v-compiles-sdl-examples:
    runs-on: ubuntu-18.04
    needs: no-scheduling
    timeout-minutes: 30
    env:
      VFLAGS: -cc tcc
    steps:
    - name: Checkout V
      uses: actions/checkout@v2
      with:
        repository: vlang/v

    - uses: actions/checkout@v2
      with:
        path: sdl

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install --quiet -y libsdl2-dev libsdl2-ttf-dev libsdl2-mixer-dev libsdl2-image-dev

    - name: Build local v
      run: make -j4

    - name: Test code formatting
      run: |
        cd sdl
        ../v test-fmt

    - name: Build sdl shared
      run: ./v -shared -g sdl

    - name: Run tests
      run: ./v test sdl

    - name: Build sdl examples
      run: |
        declare -a v_sdl_examples=('basic_window' 'tvintris')
        export VEXE=./v
        for example in "${v_sdl_examples[@]}"; do
          safe_name=$(echo "$example" | sed 's%/%-%' | sed 's%\.%-%' )
          ./v sdl/examples/$example
        done
